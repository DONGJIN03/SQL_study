## [자동차 대여 중/대여 가능 여부 구분하기]

>핵심 개념: CASE, GROUP BY, CTE

### 문제 요약
  2022년 10월 16일 기준 자동차 대여 여부를 판단하여 자동차별 '대여중', '대여 가능' 표현

### 데이터 구조
| 컬럼명 | 설명 |
|------|------|
| history_id | 자동차 대여 기록 id |
| car_id | 자동차 ID |
| start_date | 대여 시작일 |
| end_date | 대여 종료일 |
---
### 접근 방식1 (서브쿼리 및 조인 이용)
1. 모든 대여 기록에 대해 2022-10-16 기준 자동차 대여 여부를 판단하기 위해 CASE 문을 이용하여 대여 시작일과 대여 종료일 사이에 2022-10-16이 포함되면 '대여중', 그렇지 않으면 '대여 가능' 표시
2. 대여 여부 칼럼을 추가한 테이블은 가독성을 위해 WITH문을 활용하여 테이블 표현
3. 자동차별 대여 여부를 판단하기 위해 자동차 ID 기준으로 그룹화
4. 대여 여부를 판단할 때 2022-10-16 기준 대여 여부를 판단해야 하므로 MAX함수를 이용해 자동차별 기록중 해당 날짜 대여중 기록이 있으면 대여중, 그렇지 않으면 대여 가능 표현.
5. 자동차 ID 기준 내림차순 정렬 

---

### 시행착오
- 자동차별 가장 최신 대여 기록 기준 해당 날짜 대여 여부 판단 문제로 잘못 풀었음
  <br> (윈도우 함수를 이용해 자동차별 최신 대여 시작일 날짜를 구해 해당 날짜와 대여 시작 날짜가 같은 데이터만 필터링 하여 대여 여부를 구함)
- 그룹별 대여 여부를 선택하기 위해 윈도우 함수를 통해 그룹별 대여 여부를 내림 차순 정렬 후 행 번호를 추가 한 뒤 행 번호가 1인 행 데이터만 필터링 하여 사용할려고 함. -> 윈도우 함수와 CASE문 실행 순서상 서브쿼리를 여러번 작성해야하는 비효율적인 코드 작성
- 그룹 내부 '대여중', '대여 가능' 중 대여 여부를 선택 하는 과정에서 문자열에 바로 MAX 함수를 사용해 선택 가능했지만 CASE문으로 숫자(1, 0)으로 대여여부를 표현 후 MAX 함수를 취한 뒤 다시 정수(1, 0)를 '대여중'/'대여 가능' 문자열로 변환하는 비효율적인 코드 작성
   
---

### 최종 쿼리
```sql
WITH c AS (
SELECT car_id, 
       CASE
         WHEN '2022-10-16' BETWEEN start_date AND end_date THEN '대여중'
         ELSE '대여 가능'
       END AS availability
FROM car_rental_company_rental_history
)

SELECT car_id,
        MAX(availability) AS availability
FROM c
GROUP BY car_id
ORDER BY car_id DESC;     
```
